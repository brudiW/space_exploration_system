<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Artificial Horizon (Attitude Indicator)</title>
  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      background: #111;
      font-family: Arial;
      color: #eee;
    }

    .wrap {
      display: flex;
      gap: 20px;
      padding: 20px;
      height: 100%;
      box-sizing: border-box;
    }

    canvas {
      background: #000;
      border: 1px solid #444;
      border-radius: 8px;
    }

    .controls {
      width: 260px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    label {
      font-size: 14px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="controls">
      <label>Pitch <input id="pitch" type="number" min="-90" max="90" value="0"></label>
      <label>Roll <input id="roll" type="number" min="-180" max="180" value="0"></label>
      <label>Yaw <input id="yaw" type="number" min="0" max="359" value="0"></label>

      <label>Pitch <input id="pitch-r" type="number" min="-90" max="90" value="0"></label>
      <label>Roll <input id="roll-r" type="number" min="-180" max="180" value="0"></label>
      <label>Yaw <input id="yaw-r" type="number" min="-180" max="180" value="0"></label>


      <label for="azimuth">Azimuth:</label><input type="number" name="azimuth" id="azimuth" min="0" max="359" value="0">
      <label for="mode">Calc Mode</label><select name="mode" id="mode" onchange="updateMode(Number(azimuthInput.value))">
        <option value="global">GLOBAL (YAW=HDG)</option>
        <option value="local">LOCAL (YAW=PROGRADE+Â°)</option>
      </select>

    </div>
  </div>

  <script>
    const pitchInput = document.getElementById("pitch");
    const rollInput = document.getElementById("roll");
    const yawInput = document.getElementById("yaw");
    const pitchRateInput = document.getElementById("pitch-r");
    const rollRateInput = document.getElementById("roll-r");
    const yawRateInput = document.getElementById("yaw-r");
    const modeInput = document.getElementById("mode");
    const azimuthInput = document.getElementById("azimuth");


    let pitch = Number(pitchInput.value);
    let roll = Number(rollInput.value);
    let yaw = Number(yawInput.value);

    let azimuth = Number(azimuthInput.value); // ORBIT AZIMUTH on local mode

    let pitchRate = 0; // deg/sec
    let rollRate = 0;
    let yawRate = 0;

    let mode = modeInput.value;

    let lastTime = performance.now();
    const bc = new BroadcastChannel("imu");
    const rc = new BroadcastChannel("imu_rcv");
    const cmd = new BroadcastChannel("imu_cmd");

    /* =========================
       READ INITIAL CONDITIONS
    ========================= */
    function readInputs() {
      pitchRate = Number(pitchRateInput.value);
      rollRate = Number(rollRateInput.value);
      yawRate = Number(yawRateInput.value);

      // Allow manual reset of attitude
      if (document.activeElement === pitchInput)
        pitch = Number(pitchInput.value);
      if (document.activeElement === rollInput)
        roll = Number(rollInput.value);
      if (document.activeElement === yawInput)
        yaw = Number(yawInput.value);
      if (roll > 180) roll = roll - 360;
      if (roll < -180) roll = roll + 360;
    }

    setInterval(readInputs, 50);

    rc.onmessage = (e) => {
      const d = e.data;
      pitchRateInput.valueAsNumber = d[0];
      rollRateInput.valueAsNumber = d[1];
      yawRateInput.valueAsNumber = d[2];
    }
    cmd.onmessage = (e) => {
      const d = e.data;
      modeInput.value = d[0];
      azimuthInput.valueAsNumber = d[1];

    }

    /* =========================
       INTEGRATION LOOP
    ========================= */
    function update() {
      const now = performance.now();
      const dt = (now - lastTime) / 1000; // seconds
      lastTime = now;

      pitch += pitchRate * dt;
      roll += rollRate * dt;
      yaw += yawRate * dt;

      // Clamp / wrap
      pitch = ((pitch + 180) % 360) - 180;
      roll = ((roll + 180) % 360) - 180;
      yaw = (yaw + 360) % 360;

      // Update display fields
      pitchInput.value = pitch.toFixed(2);
      rollInput.value = roll.toFixed(2);
      yawInput.value = yaw.toFixed(2);
      console.log(`${pitch}, ${roll}, ${yaw}, ${pitchRate}, ${rollRate}, ${yawRate}`)

      bc.postMessage({
        pitch,
        roll,
        yaw,
        pitchRate,
        rollRate,
        yawRate
      });

      requestAnimationFrame(update);
    }
    function updateMode(azimuth) {
      let oldMode = mode;
      mode = modeInput.value;
      if (mode != oldMode) {
        if (mode == "local") {
          yaw = 0;
        } else {
          if (azimuth + yaw >= 360) {
            yaw = azimuth + yaw - 360;
          } else {
            yaw = azimuth + yaw;
          }
        }
      }
    }

    requestAnimationFrame(update);
  </script>


</body>

</html>